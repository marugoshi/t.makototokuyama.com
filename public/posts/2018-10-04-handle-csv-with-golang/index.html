<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Golang で CSV を扱う &middot; t
		</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		<link rel="stylesheet" href="/custom.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="t" />

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117975751-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-117975751-3');
    </script>
  </head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">t</h2>
				</a>
				<ul>
    <li><a href="https://www.makototokuyama.com">About</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        
        <br>
        <span>on&nbsp;</span><time datetime="2018-10-04 00:00:00 &#43;0900 JST">October 4, 2018</time>
</div>
		<h1 class="post-title">Golang で CSV を扱う</h1>
<div class="post-line"></div>

		

		

<p><a href="/posts/2018-10-02-setup-golang/">前回は Golang のローカル開発環境について</a>書いた。今回はコードを書いてみる。<a href="posts/2018-09-09-docker-with-ruby/">Docker を触ったときにも書いた通り</a>、書くからには動くものを書きたい。ということで、そのときに書いた ruby のコードを go で書きなおしてみようと思う。ファイルの入出力、文字コード周りは実用的でよい演習になりそうだ。</p>

<h2 id="ファイル構成">ファイル構成</h2>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">.
├── data/
|   └── sample.csv
├── vendor/ # (dep が生成)
├── converter.go
├── converter_test.go
├── Gopkg.lock
├── Gopkg.toml # (dep が生成)
└── main.go</code></pre></div>

<h2 id="dep">dep</h2>

<p>go のパッケージングマネージャー。以前は別パッケージだったらしいけど、現在は本家に取り込まれている。ということで、こいつを使っておけばいいんだろうな。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get -u github.com/golang/dep/cmd/dep</code></pre></div>

<h3 id="初期化">初期化</h3>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dep init</code></pre></div>

<p>プロジェクトルートで打つと <code>Gopkg.toml</code> <code>Gopkg.lock</code> <code>vendor/</code> を生成してくれる。</p>

<h3 id="必要な外部ライブラリのインストール">必要な外部ライブラリのインストール</h3>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dep ensure</code></pre></div>

<p>コードの中にある import を解析してダウンロードして <code>vendor</code> ディレクトリに保存してくれる。ライブラリ同士のバージョン依存性も解決してくれるようだ。便利すぎる。</p>

<h2 id="ソース">ソース</h2>

<p>ruby のときはだーっと書いたけど、今回は go の機能に触れる意味をこめて interface を使ってみる。といっても今回のサンプルではあまり意味のない使い方だけど。</p>

<h3 id="main-go">main.go</h3>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">SRC_PATH</span> = <span style="color:#e6db74">&#34;./data/chumon.csv&#34;</span>
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DST_PATH</span> = <span style="color:#e6db74">&#34;./data/out.csv&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">converter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConverter</span>(<span style="color:#a6e22e">SRC_PATH</span>, <span style="color:#a6e22e">DST_PATH</span>, <span style="color:#66d9ef">false</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">converter</span>.<span style="color:#a6e22e">Execute</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">2</span>)
	}
	<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">0</span>)
}</code></pre></td></tr></table>
</div>
</div>

<p>同じ階層にある converter を生成して処理結果を判別して終了している。</p>

<h3 id="converter-go">converter.go</h3>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/csv&#34;</span>
	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/text/encoding/japanese&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/text/transform&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Converter</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Execute</span>() <span style="color:#66d9ef">error</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">converter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">srcPath</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">dstPath</span>  <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">hasIndex</span> <span style="color:#66d9ef">bool</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConverter</span>(<span style="color:#a6e22e">srcPath</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">dstPath</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">hasIndex</span> <span style="color:#66d9ef">bool</span>) <span style="color:#a6e22e">Converter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">converter</span>{<span style="color:#a6e22e">srcPath</span>: <span style="color:#a6e22e">srcPath</span>, <span style="color:#a6e22e">dstPath</span>: <span style="color:#a6e22e">dstPath</span>, <span style="color:#a6e22e">hasIndex</span>: <span style="color:#a6e22e">hasIndex</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">converter</span>) <span style="color:#a6e22e">Execute</span>() <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">reader</span>, <span style="color:#a6e22e">readerClose</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">getReader</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">readerClose</span>()

	<span style="color:#a6e22e">writer</span>, <span style="color:#a6e22e">writerClose</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">getWriter</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">writerClose</span>()

	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">record</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">Read</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">hasIndex</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">createNewRecord</span>(<span style="color:#a6e22e">record</span>))
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
	}
	<span style="color:#a6e22e">writer</span>.<span style="color:#a6e22e">Flush</span>()

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">converter</span>) <span style="color:#a6e22e">getReader</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#66d9ef">func</span>(), <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">srcFile</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">srcPath</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;can not open %s&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">srcPath</span>)
	}
	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">srcFile</span>, <span style="color:#a6e22e">japanese</span>.<span style="color:#a6e22e">ShiftJIS</span>.<span style="color:#a6e22e">NewDecoder</span>()))
	<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">LazyQuotes</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reader</span>, <span style="color:#66d9ef">func</span>() { <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">srcFile</span>.<span style="color:#a6e22e">Close</span>() }, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">converter</span>) <span style="color:#a6e22e">getWriter</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">Writer</span>, <span style="color:#66d9ef">func</span>(), <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">dstFile</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dstPath</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;can not create %s&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">dstPath</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">csv</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">dstFile</span>), <span style="color:#66d9ef">func</span>() { <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dstFile</span>.<span style="color:#a6e22e">Close</span>() }, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">converter</span>) <span style="color:#a6e22e">createNewRecord</span>(<span style="color:#a6e22e">src</span> []<span style="color:#66d9ef">string</span>) []<span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dst</span> []<span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">dst</span> = append(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">normalizeCompanyName</span>(<span style="color:#a6e22e">src</span>[<span style="color:#ae81ff">2</span>]))
	<span style="color:#a6e22e">dst</span> = append(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">src</span>[<span style="color:#ae81ff">4</span>])
	<span style="color:#a6e22e">dst</span> = append(<span style="color:#a6e22e">dst</span>, <span style="color:#a6e22e">src</span>[<span style="color:#ae81ff">9</span>])
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dst</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">converter</span>) <span style="color:#a6e22e">normalizeCompanyName</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;㈱&#34;</span>, <span style="color:#e6db74">&#34;株式会社&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;㈲&#34;</span>, <span style="color:#e6db74">&#34;有限会社&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;（&#34;</span>, <span style="color:#e6db74">&#34;(&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;）&#34;</span>, <span style="color:#e6db74">&#34;)&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;(株)&#34;</span>, <span style="color:#e6db74">&#34;株式会社&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#a6e22e">s</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;(有)&#34;</span>, <span style="color:#e6db74">&#34;有限会社&#34;</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}</code></pre></td></tr></table>
</div>
</div>

<ul>
<li>import

<ul>
<li>日本語変換にはふたつ公式の外部パッケージを使っている。</li>
<li>また標準エラーの薄いラッパー pkg/errors も使っている。シンプルで使い勝手良い。</li>
</ul></li>
<li>interface

<ul>
<li>公開メソッドのインターフェースのみを定義してあり、そのメソッドを定義することでその intarface の型として振舞うことができる。</li>
</ul></li>
<li>struct

<ul>
<li>引数を持つだけの構造体。</li>
<li>メソッドも変数も、小文字始まりにすると private になる。</li>
</ul></li>
<li>Execute()

<ul>
<li>Converter interface の実装。</li>
<li>このメソッドのみを公開していて、それ以外は private メソッドになる。テストはホワイトテストをたくさん書く感じで後ほど。</li>
<li>処理の流れは以下の通り。

<ol>
<li>元になるファイルの reader を取得する</li>
<li>書き出し先のファイルの writer を取得する</li>
<li>ファイルの終端まで reader から 1 行ずつ読み込む</li>
<li>writer のバッファに 1 行ずつ書き込む</li>
<li>flush してファイルに書き込む</li>
</ol></li>
<li>それぞれの処理でエラーが発生した場合はメッセージを付与してエラーを返す。</li>
</ul></li>
<li>getReader()

<ul>
<li>io.Reader インターフェースを使った csv.Reader を生成する。読み込むだけで csv をパースしてくれる。</li>
<li>transform.Reader を使うことで文字コードの変換をしつつ読み込んでくれる。</li>
<li>返り値でメソッドを返しているのは、このメソッドの中で close してしまうとそこでファイルが閉じて読み込みができなくなってしまうため。converter struct の中にファイルポインタを指定するのでもいいんだろうけど、暗黙的にどこかで値がセットされるよりは明示的な方がいいかなと思ってこうしている。どうなんだろうね。</li>
<li>defer はメソッドの最後で実行される。どこかで panic が起きても実行されるけど、exit が起きると実行しないらしい。</li>
</ul></li>
<li>getWriter()

<ul>
<li>書き込むファイルを生成。</li>
<li>io.Writer インターフェースを使った csv.Writer を生成する。ここは普通の writer でもいいような気もするけど試していない。わざわざ実装があるってことは使った方がいいんだろうな、くらい。必要があったら勝手にクオートしてくれたりするのかな？</li>
</ul></li>
<li>createNewRecord(src []string)

<ul>
<li>CSV の 1 行を作って返す。</li>
</ul></li>
<li>normalizeCompanyName(s string)

<ul>
<li>文字列の置換を試す。</li>
</ul></li>
</ul>

<hr />

<p>ざっとこんな感じかな。シンプルに書けるけど error はやはり面倒だと感じる。次はテストも書いてみるか。</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/2018-10-02-setup-golang/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-08-29 00:41:42.5385013 &#43;0900 JST m=&#43;0.535878301">2019</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
